<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.gbif.registry.persistence.mapper.DatasetProcessStatusMapper">
  
  <resultMap id="CRAWL_JOB_MAP" type="CrawlJob">
    <constructor>
      <idArg column="dataset_key" javaType="java.util.UUID" jdbcType="OTHER"/>
      <idArg column="attempt" javaType="int"/>
      <arg column="endpoint_type" javaType="org.gbif.api.vocabulary.EndpointType" jdbcType="OTHER"/>
      <arg column="target_url" javaType="java.net.URI"/>      
    </constructor>        
  </resultMap>
  
   <!-- Partial auto-mapping -->
  <resultMap id="DATASET_PROCESS_STATUS_MAP" type="DatasetProcessStatus" autoMapping="true">  	
  	<id property="datasetUuid" column="dataset_key"/>
    <association property="crawlJob" resultMap="CRAWL_JOB_MAP"/>
  </resultMap>
  
  <sql id="DATASET_PROCESS_STATUS_FIELDS">
    dataset_key,attempt,target_url,endpoint_type,started_crawling,finished_crawling,finish_reason,pages_crawled,
    pages_fragmented_successful,pages_fragmented_error,fragments_emitted,fragments_received,
    raw_occurrences_persisted_new,raw_occurrences_persisted_updated,raw_occurrences_persisted_unchanged,
    raw_occurrences_persisted_error,fragments_processed,verbatim_occurrences_persisted_successful,
    verbatim_occurrences_persisted_error,interpreted_occurrences_persisted_successful, interpreted_occurrences_persisted_error
  </sql>  
  
  <sql id="DATASET_PROCESS_STATUS_FIELDS_TYPES">
    #{datasetUuid,jdbcType=OTHER},
    #{crawlJob.attempt,jdbcType=INTEGER},
    #{crawlJob.targetUrl,jdbcType=VARCHAR},
    #{crawlJob.endpointType,jdbcType=OTHER},
    #{startedCrawling,jdbcType=DATE},
    #{finishedCrawling,jdbcType=DATE},
    #{finishReason,jdbcType=OTHER},
    #{pagesCrawled,jdbcType=INTEGER},
    #{pagesFragmentedSuccessful,jdbcType=INTEGER},
    #{pagesFragmentedError,jdbcType=INTEGER},
    #{fragmentsEmitted,jdbcType=INTEGER},
    #{fragmentsReceived,jdbcType=INTEGER},
    #{rawOccurrencesPersistedNew,jdbcType=INTEGER},
    #{rawOccurrencesPersistedUpdated,jdbcType=INTEGER},
    #{rawOccurrencesPersistedUnchanged,jdbcType=INTEGER},
    #{rawOccurrencesPersistedError,jdbcType=INTEGER},
    #{fragmentsProcessed,jdbcType=INTEGER},
    #{verbatimOccurrencesPersistedSuccessful,jdbcType=INTEGER},
    #{verbatimOccurrencesPersistedError,jdbcType=INTEGER},
    #{interpretedOccurrencesPersistedSuccessful,jdbcType=INTEGER}, 
    #{interpretedOccurrencesPersistedError,jdbcType=INTEGER}
  </sql>  
    
  <select id="get" resultMap="DATASET_PROCESS_STATUS_MAP">
    SELECT <include refid="DATASET_PROCESS_STATUS_FIELDS"/>
    FROM crawl_history
    WHERE dataset_key = #{datasetKey,jdbcType=OTHER}
    AND attempt = #{attempt,jdbcType=INTEGER}
  </select>
  
  <insert id="create" parameterType="DatasetOccurrenceDownload">
    INSERT INTO crawl_history(<include refid="DATASET_PROCESS_STATUS_FIELDS"/>)
    VALUES(<include refid="DATASET_PROCESS_STATUS_FIELDS_TYPES"/>)
  </insert>
  
  <select id="list" resultMap="DATASET_PROCESS_STATUS_MAP" parameterType="Pageable">
    SELECT <include refid="DATASET_PROCESS_STATUS_FIELDS"/>
    FROM crawl_history    
    ORDER BY started_crawling DESC
    <if test="page != null" >
      LIMIT #{page.limit} OFFSET #{page.offset}
    </if>
  </select>
  
  <select id="count" resultType="Integer">
    SELECT COUNT(*)
    FROM crawl_history
  </select>
  
  <select id="listByDataset" resultMap="DATASET_PROCESS_STATUS_MAP" parameterType="Pageable">
    SELECT <include refid="DATASET_PROCESS_STATUS_FIELDS"/>
    FROM crawl_history
    WHERE dataset_key = #{datasetKey,jdbcType=OTHER}
    ORDER BY started_crawling DESC, attempt ASC
    <if test="page != null" >
      LIMIT #{page.limit} OFFSET #{page.offset}
    </if>
  </select>
  
  <select id="countByDataset" resultType="Integer">
    SELECT COUNT(*)
    FROM crawl_history
    WHERE dataset_key = #{datasetKey,jdbcType=OTHER}
  </select>

</mapper>